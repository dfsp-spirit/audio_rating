<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Music Rating Interface - Core Functionality</title>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        width: 100%;
        max-width: 900px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        padding: 25px;
        overflow: hidden;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 20px;
      }

      .waveform-container {
        position: relative;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      #waveform {
        width: 100%;
        height: 150px;
        cursor: pointer;
      }

      .time-display {
        text-align: center;
        font-size: 1.1rem;
        margin: 15px 0;
        font-weight: 600;
        color: #2c3e50;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      button {
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      button:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .rating-container {
        position: relative;
        height: 220px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .rating-area {
        position: relative;
        height: 100%;
        background: repeating-linear-gradient(
          to bottom,
          #f8f9fa,
          #f8f9fa 10%,
          #e9ecef 10%,
          #e9ecef 20%
        );
        cursor: pointer;
      }

      .segment {
        position: absolute;
        top: 0;
        height: 100%;
        background-color: rgba(52, 152, 219, 0.2);
        border-left: 1px solid #3498db;
        border-right: 1px solid #3498db;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #2c3e50;
        user-select: none;
        transition: all 0.2s ease;
      }

      .segment:hover {
        background-color: rgba(52, 152, 219, 0.3);
      }

      .segment-handle {
        position: absolute;
        width: 12px;
        height: 100%;
        background-color: rgba(231, 76, 60, 0.5);
        cursor: col-resize;
        z-index: 10;
      }

      .segment-handle-left {
        left: 0;
      }

      .segment-handle-right {
        right: 0;
      }

      .value-labels {
        position: absolute;
        right: 10px;
        top: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 12px;
        color: #6c757d;
        z-index: 5;
      }

      .status {
        text-align: center;
        margin-top: 15px;
        color: #7f8c8d;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Music Rating Interface</h1>

      <div class="waveform-container">
        <div id="waveform"></div>
      </div>

      <div class="time-display">
        Current time: <span id="current-time">0:00</span> /
        <span id="total-time">0:00</span>
      </div>

      <div class="controls">
        <button id="play-btn">Play/Pause</button>
        <button id="zoom-in">Zoom In</button>
        <button id="zoom-out">Zoom Out</button>
      </div>

      <div class="rating-container">
        <div class="rating-area" id="rating-area">
          <div class="value-labels">
            <span>10</span>
            <span>9</span>
            <span>8</span>
            <span>7</span>
            <span>6</span>
            <span>5</span>
            <span>4</span>
            <span>3</span>
            <span>2</span>
            <span>1</span>
            <span>0</span>
          </div>
        </div>
      </div>

      <div class="status" id="status">
        Audio loading... Double-click on the rating area to create segments
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Wavesurfer
        const wavesurfer = WaveSurfer.create({
          container: "#waveform",
          waveColor: "#3498db",
          progressColor: "#2980b9",
          cursorColor: "#2c3e50",
          cursorWidth: 2,
          height: 150,
          responsive: true,
          normalize: true,
          barWidth: 3,
          barGap: 2,
        });

        // Load a demo audio file
        wavesurfer.load("https://wavesurfer-js.org/example/media/demo.wav");

        // Time display
        const currentTimeEl = document.getElementById("current-time");
        const totalTimeEl = document.getElementById("total-time");
        const statusEl = document.getElementById("status");

        wavesurfer.on("audioprocess", () => {
          currentTimeEl.textContent = formatTime(wavesurfer.getCurrentTime());
        });

        wavesurfer.on("ready", () => {
          totalTimeEl.textContent = formatTime(wavesurfer.getDuration());
          statusEl.textContent =
            "Audio loaded. Double-click on the rating area to create segments";
        });

        wavesurfer.on("loading", (progress) => {
          statusEl.textContent = `Loading audio: ${progress}%`;
        });

        wavesurfer.on("error", (error) => {
          statusEl.textContent = `Error loading audio: ${error}. Trying alternative source...`;
          // Try an alternative audio source if the first one fails
          setTimeout(() => {
            wavesurfer.load(
              "https://www.mfiles.co.uk/mp3-downloads/brahms-st-anthony-chorale-theme-two-pianos.mp3"
            );
          }, 2000);
        });

        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);
          seconds = Math.floor(seconds % 60);
          return `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        // Play/Pause button
        document.getElementById("play-btn").addEventListener("click", () => {
          wavesurfer.playPause();
        });

        // Zoom controls
        document.getElementById("zoom-in").addEventListener("click", () => {
          wavesurfer.zoom(wavesurfer.params.minPxPerSec + 20);
        });

        document.getElementById("zoom-out").addEventListener("click", () => {
          wavesurfer.zoom(Math.max(10, wavesurfer.params.minPxPerSec - 20));
        });

        // Rating system implementation
        const ratingArea = document.getElementById("rating-area");
        let segments = [];
        let selectedSegment = null;

        // Create initial segment covering entire timeline
        createSegment(0, 100, 5);

        // Handle double clicks to create new segments
        ratingArea.addEventListener("dblclick", (e) => {
          const rect = ratingArea.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const positionPercent = (clickX / rect.width) * 100;

          // Find the segment that was clicked
          const clickedSegment = findSegmentAtPosition(positionPercent);

          if (clickedSegment) {
            splitSegment(clickedSegment, positionPercent);
            statusEl.textContent =
              "Segment created. Click on a segment and use arrow keys to adjust value";
          }
        });

        // Handle keyboard input for value adjustment
        document.addEventListener("keydown", (e) => {
          if (selectedSegment) {
            if (e.key === "ArrowUp") {
              adjustSegmentValue(selectedSegment, 1);
              e.preventDefault();
            } else if (e.key === "ArrowDown") {
              adjustSegmentValue(selectedSegment, -1);
              e.preventDefault();
            } else if (e.key === "Delete") {
              deleteSegment(selectedSegment);
              e.preventDefault();
            }
          }
        });

        // Segment functions
        function createSegment(startPercent, endPercent, value) {
          const segment = document.createElement("div");
          segment.className = "segment";
          segment.style.left = `${startPercent}%`;
          segment.style.width = `${endPercent - startPercent}%`;
          segment.dataset.value = value;
          updateSegmentVisual(segment, value);

          // Add resize handles
          const handleLeft = document.createElement("div");
          handleLeft.className = "segment-handle segment-handle-left";
          segment.appendChild(handleLeft);

          const handleRight = document.createElement("div");
          handleRight.className = "segment-handle segment-handle-right";
          segment.appendChild(handleRight);

          // Add event listeners
          segment.addEventListener("click", () => {
            selectSegment(segment);
            statusEl.textContent = `Segment selected. Value: ${selectedSegment.value}/10. Use arrow keys to adjust or Delete to remove.`;
          });

          // Add drag functionality for handles
          makeResizable(segment, handleLeft, "left");
          makeResizable(segment, handleRight, "right");

          ratingArea.appendChild(segment);

          const segmentData = {
            element: segment,
            start: startPercent,
            end: endPercent,
            value: value,
          };

          segments.push(segmentData);
          return segmentData;
        }

        function updateSegmentVisual(segment, value) {
          segment.textContent = value;
          // Calculate vertical position based on value (0-10)
          const valuePercent = 100 - value * 10;
          segment.style.background = `linear-gradient(to top, rgba(52, 152, 219, 0.3) ${valuePercent}%, rgba(52, 152, 219, 0.1) ${valuePercent}%)`;
        }

        function findSegmentAtPosition(positionPercent) {
          return segments.find(
            (seg) => positionPercent >= seg.start && positionPercent <= seg.end
          );
        }

        function splitSegment(segment, splitPosition) {
          // Create a new segment from the split point to the end of the original segment
          const newSegment = createSegment(
            splitPosition,
            segment.end,
            segment.value
          );

          // Adjust the original segment to end at the split point
          segment.end = splitPosition;
          segment.element.style.width = `${segment.end - segment.start}%`;

          // Select the new segment
          selectSegment(newSegment.element);
        }

        function selectSegment(segmentElement) {
          // Deselect currently selected segment
          if (selectedSegment) {
            selectedSegment.element.style.boxShadow = "none";
          }

          // Find the segment data
          const segmentData = segments.find(
            (seg) => seg.element === segmentElement
          );

          if (segmentData) {
            selectedSegment = segmentData;
            segmentElement.style.boxShadow = "0 0 0 2px #e74c3c";
          }
        }

        function adjustSegmentValue(segment, change) {
          const newValue = Math.min(10, Math.max(0, segment.value + change));
          segment.value = newValue;
          segment.element.dataset.value = newValue;
          updateSegmentVisual(segment.element, newValue);
        }

        function deleteSegment(segment) {
          // Find index of segment to delete
          const index = segments.indexOf(segment);
          if (index !== -1) {
            // Remove from DOM
            segment.element.remove();

            // Remove from array
            segments.splice(index, 1);

            // If this was the selected segment, clear selection
            if (selectedSegment === segment) {
              selectedSegment = null;
              statusEl.textContent =
                "Segment deleted. Double-click to create new segments.";
            }
          }
        }

        function makeResizable(segmentElement, handle, side) {
          let startX, startWidth, startLeft;

          handle.addEventListener("mousedown", function (e) {
            e.stopPropagation();

            startX = e.clientX;
            startWidth = parseFloat(segmentElement.style.width);
            startLeft = parseFloat(segmentElement.style.left);

            document.addEventListener("mousemove", resize);
            document.addEventListener("mouseup", stopResize);
          });

          function resize(e) {
            const rect = ratingArea.getBoundingClientRect();
            const dx = ((e.clientX - startX) / rect.width) * 100;

            const segmentData = segments.find(
              (seg) => seg.element === segmentElement
            );

            if (side === "left") {
              const newLeft = Math.max(
                0,
                Math.min(startLeft + dx, segmentData.end - 5)
              );
              segmentElement.style.left = `${newLeft}%`;
              segmentElement.style.width = `${startWidth - dx}%`;
              segmentData.start = newLeft;
            } else {
              const newWidth = Math.max(
                5,
                Math.min(startWidth + dx, 100 - startLeft)
              );
              segmentElement.style.width = `${newWidth}%`;
              segmentData.end = startLeft + newWidth;
            }
          }

          function stopResize() {
            document.removeEventListener("mousemove", resize);
            document.removeEventListener("mouseup", stopResize);
          }
        }
      });
    </script>
  </body>
</html>
