<!-- templates/admin_dashboard.html -->
{% extends "admin_base.html" %}

{% block title %}Dashboard - Audio Rating Admin{% endblock %}

{% block content %}
    <div style="margin-bottom: 30px;">
        <h2 style="font-size: 24px; font-weight: 600; margin-bottom: 5px;">Research Participation Dashboard</h2>
        <p class="timestamp">Real-time monitoring of study progress</p>
    </div>

    <div class="stat-grid">
        <div class="stat-card">
            <h3>Total Studies</h3>
            <div class="stat-value">{{ studies|length }}</div>
        </div>
        <div class="stat-card">
            <h3>Total Participants</h3>
            <div class="stat-value">
                {% set total_participants = [] %}
                {% for study in studies %}
                    {% for participant in study.active_participants %}
                        {% if participant.id not in total_participants %}
                            {% set _ = total_participants.append(participant.id) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {{ total_participants|length }}
            </div>
        </div>
        <div class="stat-card">
            <h3>Total Songs Rated</h3>
            <div class="stat-value">
                {% set total_songs_rated = 0 %}
                {% for study in studies %}
                    {% for participant in study.active_participants %}
                        {% set total_songs_rated = total_songs_rated + participant.songs_rated_count %}
                    {% endfor %}
                {% endfor %}
                {{ total_songs_rated }}
            </div>
        </div>
        <div class="stat-card">
            <h3>Last Update</h3>
            <div class="stat-value timestamp">{{ current_time.strftime('%H:%M') }}</div>
            <p class="timestamp">{{ current_time.strftime('%Y-%m-%d') }}</p>
        </div>
    </div>

    {% if not studies %}
    <div class="empty-state">
        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">üìä</div>
        <h3 style="margin-bottom: 10px;">No studies found</h3>
        <p>Studies will appear here once they are created via the configuration file.</p>
    </div>
    {% endif %}

    {% for study in studies %}
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
            <div>
                <h2 style="font-size: 22px; margin-bottom: 5px; color: var(--text-color);">{{ study.name }} (name_short: '{{ study.name_short }}')</h2>
                <p style="margin-bottom: 5px; color: var(--text-secondary);">{{ study.description or "No description provided" }}</p>
                <div style="color: var(--text-secondary); font-size: 14px; font-family: monospace; background: var(--bg-color); padding: 2px 8px; border-radius: 4px; display: inline-block;">
                    Start: {{ study.data_collection_start.strftime('%Y-%m-%d') }} |
                    End: {{ study.data_collection_end.strftime('%Y-%m-%d') }} |
                    {% if study.is_currently_active %}
                        <span style="color: var(--success-color); font-weight: 600;">Active</span>
                    {% else %}
                        <span style="color: var(--error-color); font-weight: 600;">Inactive</span>
                    {% endif %}
                </div>
            </div>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="text-align: center; min-width: 100px;">
                    <span style="font-size: 24px; font-weight: 600; display: block;">{{ study.active_participants_count }}</span>
                    <span style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Active</span>
                </div>
                <div style="text-align: center; min-width: 100px;">
                    <span style="font-size: 24px; font-weight: 600; display: block;">{{ study.pre_listed_count }}</span>
                    <span style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Pre-listed</span>
                </div>
                <div style="text-align: center; min-width: 100px;">
                    <span style="font-size: 24px; font-weight: 600; display: block;">{{ study.total_songs }}</span>
                    <span style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Songs</span>
                </div>
                <div style="text-align: center; min-width: 100px;">
                    <span style="font-size: 24px; font-weight: 600; display: block;">{{ study.coverage_percentage }}%</span>
                    <span style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Coverage</span>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <a href="/api/admin/datasets/download?study_name={{ study.name_short }}&format=csv"
               class="btn btn-primary" target="_blank">
                ‚¨áÔ∏è Download CSV Data
            </a>
        </div>

        {% if study.active_participants %}
        <table>
            <thead>
                <tr>
                    <th>Participant ID</th>
                    <th>Status</th>
                    <th>Songs Rated</th>
                    <th>Progress</th>
                    <th>Total Segments</th>
                    <th>Last Activity</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in study.active_participants|sort(attribute='last_activity', reverse=true) %}
                <tr>
                    <td>
                        <span style="font-family: monospace; font-size: 13px;">{{ participant.id[:12] }}...</span>
                    </td>
                    <td>
                        {% if participant.is_pre_listed %}
                            <span class="badge badge-prelisted">Pre-listed</span>
                        {% else %}
                            <span class="badge badge-unlisted">Unlisted</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="margin-bottom: 5px;">
                            {{ participant.songs_rated_count }} of {{ study.total_songs }}
                        </div>
                        {% if participant.songs_rated %}
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                            {% for song in participant.songs_rated[:3] %}
                                <span style="background: #e0f2fe; color: #0369a1; padding: 3px 8px; border-radius: 4px; font-size: 12px;">{{ song }}</span>
                            {% endfor %}
                            {% if participant.songs_rated_count > 3 %}
                                <span style="background: #e0f2fe; color: #0369a1; padding: 3px 8px; border-radius: 4px; font-size: 12px;">+{{ participant.songs_rated_count - 3 }} more</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if study.total_songs > 0 %}
                            {% set progress_percent = (participant.songs_rated_count / study.total_songs * 100)|round|int %}
                        {% else %}
                            {% set progress_percent = 0 %}
                        {% endif %}
                        <div style="margin-bottom: 5px;">{{ progress_percent }}%</div>
                        <div style="width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: var(--success-color); border-radius: 4px; width: {{ progress_percent }}%; transition: width 0.3s ease;"></div>
                        </div>
                    </td>
                    <td>
                        <strong>{{ participant.total_segments }}</strong> segments
                    </td>
                    <td class="timestamp">
                        {% if participant.last_activity %}
                            {{ participant.last_activity.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                            Never
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">üë•</div>
            <h3 style="margin-bottom: 10px;">No participants yet</h3>
            <p>No ratings have been submitted for this study.</p>
            {% if study.pre_listed_participants %}
            <p class="timestamp" style="margin-top: 10px;">
                Pre-listed participants: {{ study.pre_listed_participants|join(', ') }}
            </p>
            {% endif %}
        </div>
        {% endif %}

        {% if study.allow_unlisted_participants %}
        <p class="timestamp" style="margin-top: 15px;">
            ‚ö†Ô∏è This study allows unlisted participants.
        </p>
        {% else %}
        <p class="timestamp" style="margin-top: 15px;">
            This study does not allow unlisted participants.
        </p>
        {% endif %}
    </div>
    {% endfor %}

    <div style="text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
        Page generated on {{ current_time.strftime('%Y-%m-%d at %H:%M:%S') }} |
        <a href="/admin/api/stats" target="_blank" style="color: var(--primary-color);">View raw stats JSON</a> |
        <a href="/admin" style="color: var(--primary-color);">Refresh page</a>
    </div>
{% endblock %}